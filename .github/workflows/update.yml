name: Update Sunbay Weather Card
on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate Perfect Weather Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4*60*60*1000); // AST = UTC-4

          function safeFixed(v, digits = 1) {
            return (typeof v === "number" ? v : 0).toFixed(digits);
          }

          async function run() {
            // WEATHER
            const w = await fetch(
              "https://api.open-meteo.com/v1/forecast" +
              "?latitude=18.3258&longitude=-65.6524" +
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m,precipitation,rain,showers" +
              "&hourly=precipitation_probability,precipitation,rain,showers" +
              "&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max" +
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            ).then(r => r.json());

            // MARINE
            const m = await fetch(
              "https://marine-api.open-meteo.com/v1/marine" +
              "?latitude=18.3258&longitude=-65.6524" +
              "&hourly=wave_height,wave_direction,wave_period" +
              "&forecast_days=3&timezone=America/Puerto_Rico"
            ).then(r => r.json());

            // === FARMSENSE MOON PHASE ===
            // AST midnight timestamp
            const midnightAST = new Date(astTime);
            midnightAST.setHours(0, 0, 0, 0);
            const unixSeconds = Math.floor(midnightAST.getTime() / 1000);

            const moonUrl = `https://api.farmsense.net/v1/moonphases/?d=${unixSeconds}`;

            const moonData = await fetch(moonUrl).then(r => r.json());
            console.log("Farmsense payload:", moonData);

            const moonPhase = moonData?.[0]?.Phase ?? "Unknown";
            const moonIllum = moonData?.[0]?.Illumination ?? 0;
            const moonIndex = moonData?.[0]?.Index ?? 0;

            // Load moon icon
            const moonIconUrl =
              `https://raw.githubusercontent.com/manifestinteractive/moon-phase-icons/master/png/64/moon-phase-${String(moonIndex).padStart(2,'0')}.png`;

            let moonIcon = null;
            try {
              moonIcon = await loadImage(moonIconUrl);
            } catch (e) {
              console.warn("Moon icon failed to load, continuing without icon.");
            }

            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png"
            );

            drawCard(w, m, astTime, logo, moonIcon, moonPhase, moonIllum);
            fs.writeFileSync('sunbay_marina_forecast.png', canvas.toBuffer());
            console.log('Perfect card generated!');
          }

          function drawCard(w, m, astTime, logo, moonIcon, moonPhase, moonIllum) {
            const cur = w.current || {};
            const daily = w.daily || {};
            const h = m.hourly || {};

            // Background
            const grad = ctx.createLinearGradient(0,0,0,1080);
            grad.addColorStop(0, '#a5f3fc');
            grad.addColorStop(1, '#ecfeff');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,1080,1080);

            // LOGO + HEADER
            const logoSize = 200;
            const margin = 60;
            const logoX = margin;
            const logoY = margin;
            const logoCenterY = logoY + logoSize / 2;

            ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);

            const textX = logoX + logoSize + 50;

            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            ctx.fillStyle = '#155e75';
            ctx.font = '600 48px system-ui';
            ctx.fillText(
              astTime.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' }),
              textX,
              logoCenterY - 28
            );

            ctx.fillStyle = '#64748b';
            ctx.font = 'italic 38px system-ui';
            ctx.fillText(
              `Inshore-Fajardo Bay, PR â€¢ ${astTime.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' })} AST`,
              textX,
              logoCenterY + 28
            );

            // MOON PHASE
            const moonX = textX;
            const moonY = logoCenterY + 90;

            if (moonIcon) {
              ctx.drawImage(moonIcon, moonX, moonY, 60, 60);
            }

            ctx.fillStyle = '#334155';
            ctx.font = '28px system-ui';
            ctx.textBaseline = 'middle';
            ctx.fillText(`Moon: ${moonPhase}`, moonX + 75, moonY + 30);

            // ... rest of your card drawing code unchanged ...
          }

          run().catch(e=>{console.error(e);process.exit(1);});
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add sunbay_marina_forecast.png
          git diff --staged --quiet || git commit -m "Update weather card - Farmsense moon phase + CJS fix" && git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
