name: Update Sunbay Weather Card
on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate Perfect Weather Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4*60*60*1000); // AST = UTC-4

          function safeFixed(v, digits = 1) {
            return (typeof v === "number" ? v : 0).toFixed(digits);
          }

          function moonPhaseFraction(date) {
            const synodicMonth = 29.53058867;
            const ref = Date.UTC(2000, 0, 6, 18, 14, 0);
            const t = date.getTime();
            const daysSince = (t - ref) / 86400000;
            return (daysSince / synodicMonth) % 1;
          }

          function moonPhaseName(f) {
            const x = ((f % 1) + 1) % 1;
            if (x < 0.03) return "New Moon";
            if (x < 0.22) return "Waxing Crescent";
            if (x < 0.28) return "First Quarter";
            if (x < 0.47) return "Waxing Gibbous";
            if (x < 0.53) return "Full Moon";
            if (x < 0.72) return "Waning Gibbous";
            if (x < 0.78) return "Last Quarter";
            if (x < 0.97) return "Waning Crescent";
            return "New Moon";
          }

          function moonIllumination(f) {
            const x = ((f % 1) + 1) % 1;
            return x <= 0.5 ? x * 2 : (1 - x) * 2;
          }

          function wmo(c){
            const m={
              0:"Clear sky",1:"Mostly clear",2:"Partly cloudy",3:"Cloudy",
              45:"Fog",51:"Light drizzle",61:"Rain",63:"Rain",65:"Heavy rain",
              80:"Showers",95:"Thunderstorm"
            };
            return m[c]||"Weather";
          }

          function compass(d){
            const dirs=[
              "N","NNE","NE","ENE","E","ESE","SE","SSE",
              "S","SSW","SW","WSW","W","WNW","NW","NNW"
            ];
            return dirs[Math.round(d/22.5)%16];
          }

          async function run() {
            const w = await fetch(
              "https://api.open-meteo.com/v1/forecast" +
              "?latitude=18.3258&longitude=-65.6524" +
              "&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,winddirection_10m,precipitation,rain,showers" +
              "&hourly=precipitation_probability,precipitation,rain,showers" +
              "&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max" +
              "&timezone=America/Puerto_Rico&temperature_unit=fahrenheit&wind_speed_unit=mph"
            ).then(r => r.json());

            const m = await fetch(
              "https://marine-api.open-meteo.com/v1/marine" +
              "?latitude=18.3258&longitude=-65.6524" +
              "&hourly=wave_height,wave_direction,wave_period" +
              "&forecast_days=3&timezone=America/Puerto_Rico"
            ).then(r => r.json());

            const midnightAST = new Date(astTime);
            midnightAST.setHours(0, 0, 0, 0);

            const moonFrac = moonPhaseFraction(midnightAST);
            const moonIllum = moonIllumination(moonFrac);
            const moonPhase = moonPhaseName(moonFrac);
            const moonIndex = Math.floor(moonFrac * 28) % 28;

            const moonIconUrl =
              `https://raw.githubusercontent.com/manifestinteractive/moon-phase-icons/master/png/64/moon-phase-${String(moonIndex).padStart(2,'0')}.png`;

            let moonIcon = null;
            try {
              moonIcon = await loadImage(moonIconUrl);
            } catch (e) {
              console.warn("Moon icon failed to load.");
            }

            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png"
            );

            drawCard(w, m, astTime, logo, moonIcon, moonPhase, moonIllum);
            fs.writeFileSync('sunbay_marina_forecast.png', canvas.toBuffer());
          }

          function drawCard(w, m, astTime, logo, moonIcon, moonPhase, moonIllum) {
            const cur = w.current || {};
            const daily = w.daily || {};
            const h = m.hourly || {};

            const grad = ctx.createLinearGradient(0,0,0,1080);
            grad.addColorStop(0, '#a5f3fc');
            grad.addColorStop(1, '#ecfeff');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,1080,1080);

            const logoSize = 200;
            const margin = 60;
            const logoX = margin;
            const logoY = margin;
            const logoCenterY = logoY + logoSize / 2;

            ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);

            const textX = logoX + logoSize + 50;

            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            ctx.fillStyle = '#155e75';
            ctx.font = '600 48px system-ui';
            ctx.fillText(
              astTime.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' }),
              textX,
              logoCenterY - 28
            );

            ctx.fillStyle = '#64748b';
            ctx.font = 'italic 38px system-ui';
            ctx.fillText(
              `Inshore-Fajardo Bay, PR • ${astTime.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' })} AST`,
              textX,
              logoCenterY + 28
            );

            const moonX = textX;
            const moonY = logoCenterY + 60;

            if (moonIcon) ctx.drawImage(moonIcon, moonX, moonY, 60, 60);

            ctx.fillStyle = '#334155';
            ctx.font = '28px system-ui';
            ctx.fillText(
              `Moon Phase: ${moonPhase} • ${Math.round(moonIllum * 100)}%`,
              moonX + 75,
              moonY + 30
            );

            const contentTop = 460;
            const LEFT = 180;
            const RIGHT = 680;

            ctx.textAlign = 'left';
            ctx.fillStyle = '#1e40af';
            ctx.font = 'bold 46px system-ui';
            ctx.fillText('Weather', LEFT, contentTop);

            let y = contentTop + 90;

            ctx.font = '900 70px system-ui';
            ctx.fillStyle = '#164e63';
            ctx.fillText(`${Math.round(cur.temperature_2m || 0)}°`, LEFT, y);
            y += 70;

            ctx.font = '30px system-ui';
            ctx.fillStyle = '#475569';
            ctx.fillText(`Feels ${Math.round(cur.apparent_temperature || 0)}°F`, LEFT, y);
            y += 46;

            ctx.font = '30px system-ui';
            ctx.fill
